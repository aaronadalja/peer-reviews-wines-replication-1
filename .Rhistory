rm(list = ls())
objects()
options(error=recover, scipen=999)
# Any package that is required by the script below is given here:
# Check to see if packages are installed, if not install.
inst_pkgs = load_pkgs =  c("data.table", "tidyverse", "magrittr", "tidyselect", "stringr", "mfx", "plm", "mhurdle", "censReg", "texreg",
"survival", "margins", "xtable")
inst_pkgs = inst_pkgs[!(inst_pkgs %in% installed.packages()[,"Package"])]
if(length(inst_pkgs)) install.packages(inst_pkgs)
# Dynamically load packages
pkgs_loaded = lapply(load_pkgs, require, character.only=T)
################## DATA CLEANING #######################
# Import data #
prodata <- read.csv(file = "./data/rawdata_pro.csv", stringsAsFactors = F)
# Replace NAs with 0s for the multiple-selection questions -- these are NOT missing data, just unchecked boxes #
multivars <- vars_select(names(prodata), starts_with("eth_"), starts_with("cons_"), starts_with("learn_"), -ends_with("txt"))
prodata[, multivars][is.na(prodata[,multivars])] <- 0
# Replace Likert question missing values with a value of -1 #
likertvars <- vars_select(names(prodata), buywine, starts_with("familiar_"), starts_with("quality_"),  starts_with("wt_"),  starts_with("op_"))
prodata[, likertvars][is.na(prodata[,likertvars])] <- -1
# Create some new variables and convert Data Sets to Long Form #
# Correct 0/1 for wine knowledge test questions
prodata$d_peppery <- (prodata$test_peppery == 2)*1
prodata$d_frregion <- (prodata$test_frregion == 3)*1
prodata$d_icewine <- (prodata$test_icewine == 4)*1
prodata$test <- prodata$d_icewine + prodata$d_peppery + prodata$d_frregion
# Convert Wine data to long format #
pro.long <- gather(data = prodata, starts_with("wtp"), key = "rndwine", value = "wtp") %>% filter(!is.na(wtp))
pro.long$logwtp <- log(pro.long$wtp)
pro.long$d_wtb <- (pro.long$wtp > 0)*1
pro.long$round <- as.numeric(substr(pro.long$rndwine,4,4))
pro.long$wine <- toupper(substr(pro.long$rndwine,nchar(pro.long$rndwine)-1,nchar(pro.long$rndwine)))
## Create treatment variable & populate it across all rounds
pro.long$treat_str <- NA
pro.long$treat_str[pro.long$round==5] <- toupper(substr(pro.long$rndwine[pro.long$round==5], 6,8))
pro.long %<>% group_by(prolific_pid) %>% mutate(treat_str=max(treat_str, na.rm=T))
pro.long %<>% left_join(data.frame(treat_str=c("MID", "NYH", "NYL", "FRH", "FRL", "SPH", "SPL", "HGH", "LOW"), treatment=1:9, stringsAsFactors=F))
# Create diff WTP field
pro.long %<>% arrange(prolific_pid, wine, round) %>% group_by(prolific_pid, wine) %>% mutate(wtp1=head(wtp,1)) %>% ungroup()
pro.long %<>% mutate(diffwtp = wtp - wtp1)
# Sort for export / further analysis
pro.long %<>% dplyr::select(prolific_pid, treatment, treat_str, round, wine, logwtp, wtp, diffwtp, d_wtb, everything(), -rndwine, -wtp1) %>%
arrange(treatment, prolific_pid, wine, round)
## Add state abbreviations ##
states <- data.frame(state= -1:52, st_abbr=c("ZZ", "XX", state.abb[1:8], "DC", state.abb[9:38], "PR", state.abb[39:50]), stringsAsFactors = F)
pro.long %<>% left_join(states) %>% arrange(treatment, prolific_pid, wine, round)
# Create NY indicator variable #
pro.long$NY <- factor((!(is.na(pro.long$state))&(pro.long$state==33))*1)
# Create region variable #
region <- read_csv("./data/region.csv")
pro.long <- left_join(pro.long, region)
pro.long$region.f <- factor(pro.long$region)
pro.long$region.f[is.na(pro.long$region)] <- "ZZ"
pro.long$NE <- factor((pro.long$region.f=="NE")*1)
### Create FACTOR variables with easier to read labels
pro.long$round.f <- factor(pro.long$round, levels = 1:5, labels = c("R1_Base", "R2_Method", "R3_Taste", "R4_WS", "R5_Vivino"))
pro.long$wine.f <- factor(pro.long$wine)
pro.long$treat.f <- factor(pro.long$treatment, labels = c("MID", "NYH", "NYL", "FRH", "FRL", "SPH", "SPL", "HGH", "LOW"))
pro.long$r1 <- (pro.long$round==1)*1
pro.long$r2 <- (pro.long$round==2)*1
pro.long$r4 <- (pro.long$round==4)*1
pro.long$r5 <- (pro.long$round==5)*1
pro.long$fr <- (pro.long$wine=="FR")*1
pro.long$sp <- (pro.long$wine=="SP")*1
pro.long$us <- (pro.long$wine=="US")*1
## GENDER ##
pro.long$gender.f <- factor(pro.long$gender, levels = as.character(c(1:3,-1)),
labels = c("Male", "Female", "Other", "Skip"))
## RACE ##
pro.long %<>% mutate(eth_tot = dplyr::select(., eth_white:eth_other) %>% apply(1,sum, na.rm=T))
pro.long %<>% mutate(
race.f = factor(
case_when(
eth_tot > 1       ~ "Multi",
eth_white == 1    ~ "White",
eth_black == 1    ~ "Black",
eth_native == 1   ~ "Native",
eth_asian == 1    ~ "Asian",
eth_pacific == 1  ~ "Pacific",
eth_hispanic == 1 ~ "Hispanic",
eth_mideast == 1  ~ "MidEast",
eth_other == 1    ~ "Other",
eth_skip == 1     ~ "Skip"
),
levels = c("White", "Black", "Native", "Asian", "Pacific", "Hispanic", "MidEast", "Other", "Multi", "Skip"))
)
## EDUCATION ##
pro.long$edu.f <- factor(pro.long$edu, levels = as.character(c(1:8,-1)),
labels = c("Less HS", "High School", "Some College", "Associate", "Bachelor", "Master", "Doctoral", "Prof Deg", "Skip"))
## INCOME ##
pro.long$inc.f <- factor(pro.long$inc, levels = as.character(c(1:5,-1)),
labels = c("Less than 40K", "40K-80K","80K-120K", "120K-160K", "Over 160K", "Skip"))
## MARITAL STATUS ##
pro.long$ms.f <- factor(pro.long$ms, levels = as.character(c(1:4,-1)),
labels = c("Married", "Widowed/Divorced", "Domestic Partner", "Single", "Skip"))
## CHILD ##
pro.long$child.f = factor(pro.long$child, levels = as.character(c(0,1,-1)),
labels = c("No", "Yes", "Skip")),
## CHILD ##
pro.long$child.f = factor(pro.long$child, levels = as.character(c(0,1,-1)),
labels = c("No", "Yes", "Skip"))
View(pro.long)
save.image("prodata.RData")
pro.long2 <- pro.long %>% mutate(
testgte1 = (test>=1)*1,
demo_drop = (age <= 0) + (gender == -1) + (eth_skip == 1) + (edu == -1) + (child == -1) + (hhsize == -1) + (inc == -1) + (ms == -1)
)
reg_fcn <- function(data=pro.long2, tt, baseround, treatround=5, nyres=0:1, testsc=0:1) {
regdata <- data %>% filter(!(is.infinite(logwtp)), demo_drop==0, round %in% c(baseround,treatround),
treat_str %in% c("MID", tt), NY %in% nyres, testgte1 %in% testsc) %>%
mutate(trt = get(tt), post = get(paste0("r", treatround)), intv = tt,
pt.fr = if_else(intv %in% c("FRH", "FRL"), trt*post, trt*fr*post),
pt.sp = if_else(intv %in% c("SPH", "SPL"), trt*post, trt*sp*post),
pt.us = if_else(intv %in% c("NYH", "NYL"), trt*post, trt*us*post)
) %>% dplyr::select(logwtp, intv, trt, wine.f, post, pt.fr, pt.sp, pt.us, region.f,
age, gender.f, race.f, edu.f, child.f, hhsize, inc.f, ms.f)
if(tt %in% c("FRH", "FRL")) {
regdata$wine.f <- relevel(regdata$wine.f, ref="FR")
} else if(tt %in% c("SPH", "SPL")) {
regdata$wine.f <- relevel(regdata$wine.f, ref="SP")
} else {
regdata$wine.f <- relevel(regdata$wine.f, ref="US")
}
if(nyres[1]==1) {
reg <- lm(logwtp ~ trt + wine.f + post + pt.fr + pt.sp + pt.us + age + gender.f +
race.f + edu.f + child.f + hhsize + inc.f + ms.f, data = regdata)
} else {
reg <- lm(logwtp ~ trt + wine.f + post + pt.fr + pt.sp + pt.us + region.f + age + gender.f +
race.f + edu.f + child.f + hhsize + inc.f + ms.f, data = regdata)
}
rse.reg <- coeftest(reg, vcov = vcovHC(reg))
return(list(tt, paste(baseround, treatround, sep=":"), nyres, testsc, regdata, reg, rse.reg))
}
## Table 2 ##
# Mean WTP + StDev by wine & treatment
# All rounds
tbl2 <- pro.long %>% group_by(wine.f, treat.f) %>% summarize(mean=mean(wtp), stdev=sd(wtp))
write.csv(tbl2, "./tbl2.csv", row.names = F)
##  Table 3 - OWN AND CROSS EFFECTS OF PEER REVIEWS ##
#base round 1, 2, 4
# full controls
treatments <- c("FRH", "FRL", "SPH", "SPL", "NYH", "NYL")
ctl_rounds <- c(1,2,4)
tbl3 <- vector(mode="list", length=length(ctl_rounds))
for (i in 1:length(ctl_rounds)) {
tbl3[[i]] <- vector(mode="list", length=length(treatments))
for (j in 1:length(treatments)) {
tbl3[[i]][[j]] <- reg_fcn(tt=treatments[j], baseround=ctl_rounds[i])
}
}
colnames(pro.long)
pro.long$MID <- (pro.long$treatment==1)*1
pro.long$NYH <- (pro.long$treatment==2)*1
pro.long$NYL <- (pro.long$treatment==3)*1
pro.long$FRH <- (pro.long$treatment==4)*1
pro.long$FRL <- (pro.long$treatment==5)*1
pro.long$SPH <- (pro.long$treatment==6)*1
pro.long$SPL <- (pro.long$treatment==7)*1
pro.long$HGH <- (pro.long$treatment==8)*1
pro.long$LOW <- (pro.long$treatment==9)*1
save.image("prodata.RData")
pro.long2 <- pro.long %>% mutate(
testgte1 = (test>=1)*1,
demo_drop = (age <= 0) + (gender == -1) + (eth_skip == 1) + (edu == -1) + (child == -1) + (hhsize == -1) + (inc == -1) + (ms == -1)
)
tbl3 <- vector(mode="list", length=length(ctl_rounds))
for (i in 1:length(ctl_rounds)) {
tbl3[[i]] <- vector(mode="list", length=length(treatments))
for (j in 1:length(treatments)) {
tbl3[[i]][[j]] <- reg_fcn(tt=treatments[j], baseround=ctl_rounds[i])
}
}
htmlreg(list(tbl3[[1]][[1]][[6]], tbl3[[1]][[2]][[6]], tbl3[[1]][[3]][[6]], tbl3[[1]][[4]][[6]], tbl3[[1]][[5]][[6]], tbl3[[1]][[6]][[6]]),
file="./tbl3_1.doc", digits=3, caption.above=T, stars = c(0.01, 0.05, 0.1),
caption = "Table 3, Base Period = Round 1",
custom.model.names = c("FRH", "FRL", "SPH", "SPL", "NYH", "NYL"),
custom.coef.map = list("pt.fr" = "FR", "pt.sp" = "SP", "pt.us" = "NY"),
override.se = list(tbl3[[1]][[1]][[7]][,2], tbl3[[1]][[2]][[7]][,2], tbl3[[1]][[3]][[7]][,2], tbl3[[1]][[4]][[7]][,2], tbl3[[1]][[5]][[7]][,2], tbl3[[1]][[6]][[7]][,2]),
override.pvalues = list(tbl3[[1]][[1]][[7]][,4], tbl3[[1]][[2]][[7]][,4], tbl3[[1]][[3]][[7]][,4], tbl3[[1]][[4]][[7]][,4], tbl3[[1]][[5]][[7]][,4], tbl3[[1]][[6]][[7]][,4]),
custom.note = "Note: Robust standard errors are reported in parentheses. Asterisk (*), double asterisk (**), and triple asterisk (***)
indicate significance at the 10, 5 and 1 percent level, respectively. We include region fixed effects plus individual-level control
variables for age, gender, ethnicity, education, income, marital status, household size, and a dummy for whether the individual has children."
)
tblA1 <- vector(mode="list", length=length(treatments))
for(j in 1:length(treatments)) {
tblA1[[j]] <- reg_fcn(tt=treatments[j], baseround=1, treatround=2)
}
htmlreg(list(tblA1[[1]][[6]], tblA1[[2]][[6]], tblA1[[3]][[6]], tblA1[[4]][[6]], tblA1[[5]][[6]], tblA1[[6]][[6]]),
file="./tblA1.doc", digits=3, caption.above=T, stars = c(0.01, 0.05, 0.1),
caption = "Table A1, Base Period = Round 1, Treatment Period = Round 2",
custom.model.names = c("FRH", "FRL", "SPH", "SPL", "NYH", "NYL"),
custom.coef.map = list("pt.fr" = "FR", "pt.sp" = "SP", "pt.us" = "NY"),
override.se = list(tblA1[[1]][[7]][,2], tblA1[[2]][[7]][,2], tblA1[[3]][[7]][,2], tblA1[[4]][[7]][,2], tblA1[[5]][[7]][,2], tblA1[[6]][[7]][,2]),
override.pvalues = list(tblA1[[1]][[7]][,4], tblA1[[2]][[7]][,4], tblA1[[3]][[7]][,4], tblA1[[4]][[7]][,4], tblA1[[5]][[7]][,4], tblA1[[6]][[7]][,4]),
custom.note = "Note: Robust standard errors are reported in parentheses. Asterisk (*), double asterisk (**), and triple asterisk (***)
indicate significance at the 10, 5 and 1 percent level, respectively. We include region fixed effects plus individual-level control
variables for age, gender, ethnicity, education, income, marital status, household size, and a dummy for whether the individual has children."
)
hbtreats <- c("NYH", "NYL")
ny <- c(0,1)
tbl4 <- vector(mode="list", length=length(ctl_rounds))
for (i in 1:length(ctl_rounds)) {
tbl4[[i]] <- vector(mode="list", length=length(hbtreats))
for (m in 1:length(hbtreats)) {
tbl4[[i]][[m]] <- vector(mode="list", length=length(ny))
for (n in 1:length(ny)) {
tbl4[[i]][[m]][[n]] <- reg_fcn(tt=hbtreats[m], baseround=ctl_rounds[i], nyres=ny[n])
}
}
}
htmlreg(list(tbl4[[1]][[1]][[1]][[6]], tbl4[[1]][[1]][[2]][[6]], tbl4[[1]][[2]][[1]][[6]], tbl4[[1]][[2]][[2]][[6]]),
file="./tbl4_1.doc", digits=3, caption.above=T, stars = c(0.01, 0.05, 0.1),
caption = "Table 4, Base Period = Round 1",
custom.model.names = c("NYH, NY=No", "NYH, NY=Yes", "NYL, NY=No", "NYL, NY=Yes"),
custom.coef.map = list("pt.fr" = "FR", "pt.sp" = "SP", "pt.us" = "NY"),
override.se = list(tbl4[[1]][[1]][[1]][[7]][,2], tbl4[[1]][[1]][[2]][[7]][,2], tbl4[[1]][[2]][[1]][[7]][,2], tbl4[[1]][[2]][[2]][[7]][,2]),
override.pvalues = list(tbl4[[1]][[1]][[1]][[7]][,4], tbl4[[1]][[1]][[2]][[7]][,4], tbl4[[1]][[2]][[1]][[7]][,4], tbl4[[1]][[2]][[2]][[7]][,4]),
custom.note = "Note: Robust standard errors are reported in parentheses. Asterisk (*), double asterisk (**), and triple asterisk (***)
indicate significance at the 10, 5 and 1 percent level, respectively. We include region fixed effects plus individual-level control
variables for age, gender, ethnicity, education, income, marital status, household size, and a dummy for whether the individual has children."
)
hbtreats_fr <- c("FRH", "FRL")
tblA2 <- vector(mode="list", length=length(ctl_rounds))
for (i in 1:length(ctl_rounds)) {
tblA2[[i]] <- vector(mode="list", length=length(hbtreats_fr))
for (p in 1:length(hbtreats_fr)) {
tblA2[[i]][[p]] <- vector(mode="list", length=length(ny))
for (n in 1:length(ny)) {
tblA2[[i]][[p]][[n]] <- reg_fcn(tt=hbtreats_fr[p], baseround=ctl_rounds[i], nyres=ny[n])
}
}
}
htmlreg(list(tblA2[[1]][[1]][[1]][[6]], tblA2[[1]][[1]][[2]][[6]], tblA2[[1]][[2]][[1]][[6]], tblA2[[1]][[2]][[2]][[6]]),
file="./tblA2_1.doc", digits=3, caption.above=T, stars = c(0.01, 0.05, 0.1),
caption = "Table A2, Base Period = Round 1",
custom.model.names = c("FRH, NY=No", "FRH, NY=Yes", "FRL, NY=No", "FRL, NY=Yes"),
custom.coef.map = list("pt.fr" = "FR", "pt.sp" = "SP", "pt.us" = "NY"),
override.se = list(tblA2[[1]][[1]][[1]][[7]][,2], tblA2[[1]][[1]][[2]][[7]][,2], tblA2[[1]][[2]][[1]][[7]][,2], tblA2[[1]][[2]][[2]][[7]][,2]),
override.pvalues = list(tblA2[[1]][[1]][[1]][[7]][,4], tblA2[[1]][[1]][[2]][[7]][,4], tblA2[[1]][[2]][[1]][[7]][,4], tblA2[[1]][[2]][[2]][[7]][,4]),
custom.note = "Note: Robust standard errors are reported in parentheses. Asterisk (*), double asterisk (**), and triple asterisk (***)
indicate significance at the 10, 5 and 1 percent level, respectively. We include region fixed effects plus individual-level control
variables for age, gender, ethnicity, education, income, marital status, household size, and a dummy for whether the individual has children."
)
test <- c(0,1)
tbl5 <- vector(mode="list", length=length(ctl_rounds))
for (i in 1:length(ctl_rounds)) {
tbl5[[i]] <- vector(mode="list", length=length(hbtreats))
for (m in 1:length(hbtreats)) {
tbl5[[i]][[m]] <- vector(mode="list", length=length(test))
for (q in 1:length(test)) {
tbl5[[i]][[m]][[q]] <- reg_fcn(tt=hbtreats[m], baseround=ctl_rounds[i], testsc=test[q])
}
}
}
htmlreg(list(tbl5[[1]][[1]][[1]][[6]], tbl5[[1]][[1]][[2]][[6]], tbl5[[1]][[2]][[1]][[6]], tbl5[[1]][[2]][[2]][[6]]),
file="./tbl5_1.doc", digits=3, caption.above=T, stars = c(0.01, 0.05, 0.1),
caption = "Table 5, Base Period = Round 1",
custom.model.names = c("NYH, Test < 1", "NYH, Test >= 1", "NYL, Test < 1", "NYL, Test >= 1"),
custom.coef.map = list("pt.fr" = "FR", "pt.sp" = "SP", "pt.us" = "NY"),
override.se = list(tbl5[[1]][[1]][[1]][[7]][,2], tbl5[[1]][[1]][[2]][[7]][,2], tbl5[[1]][[2]][[1]][[7]][,2], tbl5[[1]][[2]][[2]][[7]][,2]),
override.pvalues = list(tbl5[[1]][[1]][[1]][[7]][,4], tbl5[[1]][[1]][[2]][[7]][,4], tbl5[[1]][[2]][[1]][[7]][,4], tbl5[[1]][[2]][[2]][[7]][,4]),
custom.note = "Note: Robust standard errors are reported in parentheses. Asterisk (*), double asterisk (**), and triple asterisk (***)
indicate significance at the 10, 5 and 1 percent level, respectively. We include region fixed effects plus individual-level control
variables for age, gender, ethnicity, education, income, marital status, household size, and a dummy for whether the individual has children."
)
tblA4 <- vector(mode="list", length=length(ctl_rounds))
for (i in 1:length(ctl_rounds)) {
tblA4[[i]] <- vector(mode="list", length=length(hbtreats_fr))
for (p in 1:length(hbtreats_fr)) {
tblA4[[i]][[p]] <- vector(mode="list", length=length(test))
for (q in 1:length(test)) {
tblA4[[i]][[p]][[q]] <- reg_fcn(tt=hbtreats_fr[p], baseround=ctl_rounds[i], testsc=test[q])
}
}
}
htmlreg(list(tblA4[[1]][[1]][[1]][[6]], tblA4[[1]][[1]][[2]][[6]], tblA4[[1]][[2]][[1]][[6]], tblA4[[1]][[2]][[2]][[6]]),
file="./tblA4_1.doc", digits=3, caption.above=T, stars = c(0.01, 0.05, 0.1),
caption = "Table A4, Base Period = Round 1",
custom.model.names = c("FRH, Test < 1", "FRH, Test >= 1", "FRL, Test < 1", "FRL, Test >= 1"),
custom.coef.map = list("pt.fr" = "FR", "pt.sp" = "SP", "pt.us" = "NY"),
override.se = list(tblA4[[1]][[1]][[1]][[7]][,2], tblA4[[1]][[1]][[2]][[7]][,2], tblA4[[1]][[2]][[1]][[7]][,2], tblA4[[1]][[2]][[2]][[7]][,2]),
override.pvalues = list(tblA4[[1]][[1]][[1]][[7]][,4], tblA4[[1]][[1]][[2]][[7]][,4], tblA4[[1]][[2]][[1]][[7]][,4], tblA4[[1]][[2]][[2]][[7]][,4]),
custom.note = "Note: Robust standard errors are reported in parentheses. Asterisk (*), double asterisk (**), and triple asterisk (***)
indicate significance at the 10, 5 and 1 percent level, respectively. We include region fixed effects plus individual-level control
variables for age, gender, ethnicity, education, income, marital status, household size, and a dummy for whether the individual has children."
)
